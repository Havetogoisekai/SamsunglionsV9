<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì•„ìŠ¤ì½”ë¥´ë¸Œì‚° ì¶”ì •ê¸°</title>
  <style>
    body { font-family: sans-serif; text-align: center; margin: 2rem; }
    canvas { border: 1px solid #ccc; margin-top: 1rem; }
    #qr { margin-top: 2rem; }
  </style>
</head>
<body>
  <h1>ğŸŠ ìŒì‹ ì† ì•„ìŠ¤ì½”ë¥´ë¸Œì‚°(ë¹„íƒ€ë¯¼ C) ì¶”ì •ê¸°</h1>
  <input type="file" accept="image/*" id="fileInput">
  <br>
  <canvas id="canvas"></canvas>
  <p>ìº”ë²„ìŠ¤ë¥¼ í´ë¦­í•´ì„œ ìƒ‰ìƒ í”½ì…€ì„ ì„ íƒí•˜ì„¸ìš”.</p>

  <h3>ë³´ì • ë°ì´í„° ì¶”ê°€</h3>
  <input type="number" id="measured" placeholder="ì‹¤ì œ ë†ë„ (mg/100g)"> 
  <button id="addPoint">ë³´ì •ì  ì¶”ê°€</button>
  <ul id="calibList"></ul>

  <button id="fitCurve">ë³´ì •ê³¡ì„  ì í•©</button>
  <p id="fitResult"></p>

  <button id="estimate">í˜„ì¬ ì‚¬ì§„ìœ¼ë¡œ ë†ë„ ì¶”ì •</button>
  <p id="estimateResult"></p>

  <h2>ğŸ”— QR ì½”ë“œ ë§Œë“¤ê¸°</h2>
  <p>ì´ í˜ì´ì§€ ë§í¬ë¥¼ QR ì½”ë“œë¡œ ë§Œë“¤ì–´ ê³µìœ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
  <button id="makeQR">QR ì½”ë“œ ìƒì„±</button>
  <div id="qr"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');

    let img = new Image();
    let calibPoints = [];
    let slope = null, intercept = null;

    fileInput.addEventListener('change', e => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = ev => {
        img.onload = () => {
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0);
        };
        img.src = ev.target.result;
      };
      reader.readAsDataURL(file);
    });

    canvas.addEventListener('click', e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const pixel = ctx.getImageData(x, y, 1, 1).data;
      const avg = (pixel[0] + pixel[1] + pixel[2]) / 3;
      document.getElementById('estimateResult').innerText = `ì„ íƒí•œ í”½ì…€ ë°ê¸°: ${avg.toFixed(2)}`;
      window.lastValue = avg;
    });

    document.getElementById('addPoint').addEventListener('click', () => {
      if (window.lastValue && document.getElementById('measured').value) {
        const real = parseFloat(document.getElementById('measured').value);
        calibPoints.push([window.lastValue, real]);
        const li = document.createElement('li');
        li.innerText = `ë°ê¸° ${window.lastValue.toFixed(2)} â†’ ì‹¤ì œ ${real}`;
        document.getElementById('calibList').appendChild(li);
      }
    });

    document.getElementById('fitCurve').addEventListener('click', () => {
      if (calibPoints.length < 2) {
        alert('ë³´ì •ì ì´ 2ê°œ ì´ìƒ í•„ìš”í•©ë‹ˆë‹¤!');
        return;
      }
      let sumX=0,sumY=0,sumXY=0,sumXX=0;
      calibPoints.forEach(([x,y])=>{sumX+=x; sumY+=y; sumXY+=x*y; sumXX+=x*x;});
      const n = calibPoints.length;
      slope = (n*sumXY - sumX*sumY)/(n*sumXX - sumX*sumX);
      intercept = (sumY - slope*sumX)/n;
      document.getElementById('fitResult').innerText = `ë³´ì •ì‹: ë†ë„ = ${slope.toFixed(3)}*ë°ê¸° + ${intercept.toFixed(3)}`;
    });

    document.getElementById('estimate').addEventListener('click', () => {
      if (slope === null) { alert('ë¨¼ì € ë³´ì •ê³¡ì„ ì„ ì í•©í•˜ì„¸ìš”!'); return; }
      if (!window.lastValue) { alert('ì´ë¯¸ì§€ì—ì„œ í”½ì…€ì„ ì„ íƒí•˜ì„¸ìš”!'); return; }
      const est = slope*window.lastValue + intercept;
      document.getElementById('estimateResult').innerText = `ì¶”ì • ë†ë„: ${est.toFixed(2)} mg/100g`;
    });

    document.getElementById('makeQR').addEventListener('click', () => {
      document.getElementById('qr').innerHTML = '';
      const qr = new QRious({
        element: document.createElement('canvas'),
        value: window.location.href,
        size: 200
      });
      document.getElementById('qr').appendChild(qr.element);
    });
  </script>
</body>
</html>
